# Организатор Проекта: GS2 (Arsenal Football School)

Этот документ служит центральным источником информации о проекте, его архитектуре, текущем состоянии и рабочем процессе.

## 1. Общий Анализ Проекта

### 1.1. Краткое описание

Проект представляет собой веб-приложение для управления футбольной школой. Он включает в себя функциональность для разных ролей (менеджер, тренер, родитель, ребенок) и позволяет управлять филиалами, абонементами, тренировками, а также отслеживать прогресс учеников.

### 1.2. Архитектура

#### Фронтенд
*   **Технологии:** React.js, `react-native-web` для стилизации.
*   **Маршрутизация:** `react-router-dom` для навигации на стороне клиента.
*   **Управление состоянием:** `React Context` (`AuthContext`) для аутентификации. Локальное состояние в компонентах для остальной логики.
*   **Взаимодействие с API:** Централизовано через кастомный хук `useCrud` и обертку `api.js`.
*   **Сборка:** Webpack, настроенный для разработки с `webpack-dev-server` и проксированием `/api` запросов на бэкенд.

#### Бэкенд
*   **Технологии:** PHP (без фреймворков), MySQL.
*   **Архитектура:** Процедурный стиль. Центральный маршрутизатор `server/index.php` обрабатывает все запросы к `/api` и подключает соответствующий файл-обработчик ресурса (например, `users.php`, `trainings.php`).
*   **Аутентификация:** Основана на сессиях PHP (`$_SESSION`).
*   **База данных:** Управляется через Docker Compose (`docker-compose.yml`).

#### База данных
*   **СУБД:** MySQL 8.0.
*   **Схема:** Определена и инициализируется через `server/init.sql`. Включает таблицы для пользователей, профилей, детей, филиалов, тренировок, дисциплин, абонементов и прогресса.
*   **Данные:** `init.sql` содержит демонстрационные данные для всех основных сущностей.

## 2. Контекст и Память (Сохраненные требования)

### 2.1. Предпочтения пользователя
*   **Язык общения:** Русский.
*   **Автоматические исправления:** Разрешено применять исправления и вести историю изменений.

### 2.2. Требования к проекту
*   **Хостинг:** Beget, MySQL 8.
*   **Дизайн:** Должен соответствовать стилю ФК "Арсенал".
*   **Восстановление пароля:** Вручную через Управляющего.
*   **Push-уведомления:** Реализовывать без сторонних сервисов.
*   **Ключевые функции системы:**
    1.  **Отслеживание прогресса:** По дисциплинам (время, количество, проценты). Просмотр доступен всем, редактирование — тренерам/менеджерам.
    2.  **Система абонементов/кредитов:** Менеджеры начисляют кредиты, родители/дети используют их для записи на тренировки, тренеры списывают при посещении.
    3.  **Семейные аккаунты:** Родители синхронизированы и видят отдельные балансы кредитов для каждого своего ребенка.
    4.  **Календарь:** Для управления и записи на тренировки.

### 2.3. Тестовые данные
*   **Менеджер:** `manager@school.com` / `admin`
*   **Тренер:** `trainer1@school.com` / `admin`
*   **Родитель:** `parent1@school.com` / `admin`
*   **Источник правды:** Актуальные данные для входа всегда находятся в файле `server/init.sql`.

## 3. Механика Работы и Стиль Кода

### 3.1. Мой рабочий процесс
Я придерживаюсь следующего цикла при решении задач:
1.  **Анализ и Понимание:** Изучаю задачу и соответствующий код. Использую инструменты `read_file`, `glob`, `search_file_content` для анализа структуры проекта, поиска нужных файлов и понимания существующей логики.
2.  **Планирование:** Составляю план действий. Для сложных задач я делюсь планом с вами перед его выполнением.
3.  **Реализация:** Вношу изменения в код с помощью инструментов `replace` или `write_file`, строго придерживаясь стиля и архитектуры проекта.
4.  **Проверка:** После внесения изменений я проверяю их работоспособность. В данном проекте это включает перезапуск серверов и проверку функциональности в браузере. При необходимости я прошу вас предоставить логи из консоли.
5.  **Работа с Git:** После успешной проверки я готовлю коммит: добавляю измененные файлы (`git add`), пишу осмысленное сообщение (`git commit`) и отправляю изменения на GitHub (`git push`), если вы об этом просите.

### 3.2. Стиль кода

#### PHP (Бэкенд)
*   **Стиль:** Процедурный.
*   **Маршрутизация:** Один главный файл `index.php` подключает нужный API-файл.
*   **Переменные:** `snake_case` (например, `$user_id`).
*   **Взаимодействие с БД:** `mysqli` с использованием подготовленных выражений для безопасности.
*   **Ответы API:** Всегда JSON в формате `{ "success": true, "data_key": [...] }`, где `data_key` соответствует названию ресурса (например, `branches`, `users`).

#### JavaScript (Фронтенд)
*   **Стиль:** Функциональные компоненты с хуками.
*   **Переменные:** `camelCase` (например, `userId`).
*   **Стилизация:** `react-native-web` (`StyleSheet.create`). Стили пишутся в `camelCase`.
*   **Взаимодействие с API:** Через хук `useCrud(endpointName)`, который ожидает ответа в формате, описанном выше.

#### Git
*   **Коммиты:** Я стараюсь делать атомарные коммиты, группируя связанные изменения.
*   **Сообщения:** Использую стиль "Conventional Commits". Например:
    *   `fix(backend): ...` — для исправления ошибок.
    *   `feat(frontend): ...` — для добавления новой функциональности.

## 4. История Решенных Проблем

Этот раздел документирует основные проблемы, с которыми мы столкнулись, и их решения.

1.  **Проблема: Ошибки `ECONNREFUSED` и `mysqli object is already closed`.**
    *   **Симптомы:** Фронтенд не мог подключиться к бэкенду; PHP выдавал фатальную ошибку о том, что объект соединения с БД уже закрыт.
    *   **Причина:** Бэкенд-сервер не был запущен. Кроме того, каждый API-файл (`branches.php` и т.д.) самостоятельно закрывал соединение с БД, что приводило к конфликту с главным файлом `index.php`, который также пытался его закрыть.
    *   **Решение:** Я удалил все дублирующиеся вызовы `$conn->close()` и `session_start()` из отдельных API-файлов, централизовав эту логику в `index.php`.

2.  **Проблема: Ошибки `404 Not Found` и `Child profile not found` для роли менеджера.**
    *   **Симптомы:** При просмотре страницы "Прогресс" под ролью менеджера данные не загружались.
    *   **Причина:** В `progress.php` отсутствовала логика для роли `manager`, из-за чего выполнение кода попадало в неверный блок `else`, возвращавший ошибку 404.
    *   **Решение:** Я добавил в `progress.php` специальную обработку для роли `manager`, которая позволяет просматривать все записи без фильтрации.

3.  **Проблема: Уведомление "Failed to fetch disciplines".**
    *   **Симптомы:** На фронтенде появлялось системное уведомление об ошибке загрузки данных.
    *   **Причина:** API-эндпоинт `disciplines.php` возвращал "сырой" массив JSON, в то время как фронтенд-хук `useCrud` ожидал объект формата `{ success: true, disciplines: [...] }`.
    *   **Решение:** Я изменил `disciplines.php`, чтобы он оборачивал ответ в правильную структуру. Также я улучшил хук `useCrud`, добавив более строгую проверку формата данных.

4.  **Проблема: Искаженный текст (кракозябры) на кириллице.**
    *   **Симптомы:** Вместо русских букв отображались символы вроде `Ð—Ð¼ÐµÐ¹ÐºÐ°`.
    *   **Причина:** Отдельные API-файлы устанавливали заголовок `Content-Type` без указания кодировки `charset=utf-8`, что перезаписывало правильный заголовок из `index.php`.
    *   **Решение:** Я удалил все дублирующиеся заголовки `Content-Type` из API-файлов.

5.  **Проблема: Ошибки `403 Forbidden` и `400 Bad Request` при обновлении (PUT) данных.**
    *   **Симптомы:** Не работало редактирование в большинстве разделов.
    *   **Причина:** API-файлы неверно пытались получить `id` записи из `$_GET`, который пуст при `PUT`-запросах. Правильный `id` передавался в URL, но перезаписывался в дочерних скриптах.
    *   **Решение:** Я убрал локальное переопределение переменной `$id` из всех API-файлов, чтобы использовался корректный `id`, полученный из URL в `index.php`.

6.  **Проблема: Не работало редактирование тренировок и дисциплин.**
    *   **Симптомы:** Форма редактирования закрывалась, но данные не сохранялись; в консоли были предупреждения о "неконтролируемых инпутах".
    *   **Причина:**
        1.  В `disciplines.php` не обрабатывалось поле `measurement_type` при обновлении.
        2.  В `Trainings.js` в состояние редактируемого элемента попадали `null` значения из API, что вызывало ошибки в React.
    *   **Решение:**
        1.  Я исправил `disciplines.php`, добавив обработку `measurement_type` и перевел запрос на подготовленные выражения для безопасности.
        2.  Я исправил `Trainings.js`, добавив "очистку" данных от `null` значений перед записью в состояние.

7.  **Проблема: Ошибка входа в аккаунт родителя.**
    *   **Симптомы:** `401 Unauthorized` при попытке входа.
    *   **Причина:** Изначально я предоставил неверные данные из своей памяти. После этого выяснилось, что в `auth.php` была лишняя и мешающая выполнению кода обертка `if (basename(__FILE__) === 'auth.php')`.
    *   **Решение:** Я предоставил верные данные из `init.sql` и убрал лишнюю конструкцию `if` из `auth.php`.

8.  **Проблема: Ошибка `Unexpected text node` в React.**
    *   **Симптомы:** При открытии формы редактирования или добавлении новой записи в разделе "Прогресс" приложение "падало" с ошибкой `Unexpected text node: .`.
    *   **Причина:** Использование логического оператора `&&` для условного рендеринга компонентов. Конструкция вида `условие && <Компонент />` небезопасна. Если `условие` оказывается не `false`, а другим "ложным" значением (например, пустой строкой `''`), React пытается отрендерить это значение, что в `react-native-web` приводит к ошибке.
    *   **Решение:** Я заменил все небезопасные конструкции `&&` на тернарный оператор `условие ? <Компонент /> : null`. Этот подход гарантирует, что в DOM будет вставлен либо компонент, либо `null`, что является правильным и безопасным способом условного рендеринга в React.