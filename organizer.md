# Организатор Проекта: GS2 (Arsenal Football School)

Этот документ служит центральным источником информации о проекте, его архитектуре, текущем состоянии и рабочем процессе.

## 1. Общий Анализ Проекта

### 1.1. Краткое описание

Проект представляет собой веб-приложение для управления футбольной школой. Он включает в себя функциональность для разных ролей (менеджер, тренер, родитель, ребенок) и позволяет управлять филиалами, абонементами, тренировками, а также отслеживать прогресс учеников.

### 1.2. Архитектура

#### Фронтенд
*   **Технологии:** React.js, `react-native-web` для стилизации.
*   **Маршрутизация:** `react-router-dom` для навигации на стороне клиента.
*   **Управление состоянием:** `React Context` (`AuthContext`) для аутентификации. Локальное состояние в компонентах для остальной логики.
*   **Взаимодействие с API:** Централизовано через кастомный хук `useCrud` и обертку `api.js`.
*   **Сборка:** Webpack, настроенный для разработки с `webpack-dev-server` и проксированием `/api` запросов на бэкенд.

#### Бэкенд
*   **Технологии:** PHP (без фреймворков), MySQL.
*   **Архитектура:** Процедурный стиль. Центральный маршрутизатор `server/.router.php` обрабатывает все запросы к `/api` и подключает соответствующий файл-обработчик ресурса (например, `users.php`, `trainings.php`).
*   **Аутентификация:** Основана на сессиях PHP (`$_SESSION`).
*   **База данных:** Локальный MySQL Community Server.

#### База данных
*   **СУБД:** MySQL 8.0.
*   **Схема:** Определена и инициализируется через `server/init.sql`. Включает таблицы для пользователей, профилей, детей, филиалов, тренировок, дисциплин, абонементов и прогресса.
*   **Данные:** `init.sql` содержит демонстрационные данные для всех основных сущностей.

## 2. Контекст и Память (Сохраненные требования)

### 2.1. Предпочтения пользователя
*   **Язык общения:** Русский.
*   **Автоматические исправления:** Разрешено применять исправления и вести историю изменений.

### 2.2. Требования к проекту
*   **Хостинг:** Beget, MySQL 8.
*   **Дизайн:** Должен соответствовать стилю ФК "Арсенал".
*   **Восстановление пароля:** Вручную через Управляющего.
*   **Push-уведомления:** Реализовывать без сторонних сервисов.
*   **Ключевые функции системы:**
    1.  **Отслеживание прогресса:** По дисциплинам (время, количество, проценты). Просмотр доступен всем, редактирование — тренерам/менеджерам.
    2.  **Система абонементов/кредитов:** Менеджеры начисляют кредиты, родители/дети используют их для записи на тренировки, тренеры списывают при посещении.
    3.  **Семейные аккаунты:** Родители синхронизированы и видят отдельные балансы кредитов для каждого своего ребенка.
    4.  **Календарь:** Для управления и записи на тренировки.

### 2.3. Тестовые данные
*   **Менеджер:** `manager@school.com` / `password`
*   **Тренер:** `trainer1@school.com` / `password`
*   **Родитель:** `parent1@school.com` / `password`
*   **Источник правды:** Актуальные данные для входа всегда находятся в файле `server/init.sql`.

## 3. Механика Работы и Стиль Кода

...

## 4. История Решенных Проблем

## 5. Реализованный Функционал

1.  **Полная локализация интерфейса (RU).**
    *   Все компоненты в папке `src/components` были проанализированы, и весь пользовательский текст (заголовки, кнопки, плейсхолдеры) был переведен на русский язык.

2.  **Редизайн и расширение Личных Кабинетов.**
    *   **Кабинет Родителя:** Полностью переработан с использованием вкладок ("Мои дети", "Прогресс", "Новости"). Реализована логика просмотра общего и отфильтрованного прогресса по детям.
    *   **Кабинет Тренера:** Также переведен на систему вкладок ("Расписание", "Прогресс") для консистентности и удобства навигации.

3.  **Система записи на тренировки (для Родителей).**
    *   **Этап 1 (Просмотр):** В кабинете родителя создана вкладка "Тренировки", где отображается список всех предстоящих занятий, доступных для детей этого родителя.
    *   **Этап 2 (Запись):** Реализован полный цикл записи: кнопка "Записаться" открывает модальное окно для выбора ребенка; бэкенд `attendance.php` доработан для обработки этой записи, создавая в базе данных запись со статусом `enrolled`.
    *   **Этап 3 (История и статусы):** В интерфейс добавлено отображение статуса "Вы записаны" для уже зарезервированных тренировок, а также добавлен раздел "История записей" для просмотра прошлых и будущих посещений.

1.  **Проблема: Полный отказ системы аутентификации и загрузки данных (сентябрь 2025).**
    *   **Симптомы:** Каскад ошибок: `404 Not Found` на все API-запросы, `SyntaxError: Unexpected token '<'` при логине, `401 Unauthorized` после логина, `Unexpected text node` при рендеринге.
    *   **Причина:** Цепочка из нескольких взаимосвязанных проблем на всех уровнях приложения.
        1.  **Бэкенд (Маршрутизация):** PHP-сервер запускался без кастомного роутера, а сам роутер (`.router.php`) был написан некорректно. Он не понимал вложенные URL с ID (например, `/api/users/1`) и неправильно обрабатывал другие запросы.
        2.  **Бэкенд (Сессии и CORS):** В API-файлах отсутствовал запуск сессий (`session_start()`) и были неверные заголовки CORS (`Access-Control-Allow-Origin: *`), что не позволяло браузеру отправлять cookie и приводило к ошибкам авторизации.
        3.  **Фронтенд (API):** Код отправлял запросы на неверные адреса (например, `/api/auth.php` вместо `/api/auth`).
        4.  **Фронтенд (Рендеринг):** В коде использовалась небезопасная конструкция `условие && <Компонент />`. Когда `условие` становилось пустой строкой (`''`), React пытался ее отрендерить, что вызывало падение приложения.
    *   **Решение (комплексное):**
        1.  **Маршрутизатор:** `server/.router.php` был полностью переписан для корректной обработки ресурсов и ID из URL.
        2.  **Заголовки и сессии:** Во все файлы в `server/api/` был добавлен стандартизированный блок заголовков с `Access-Control-Allow-Origin: http://localhost:9000`, `Access-Control-Allow-Credentials: true` и вызовом `session_start()`.
        3.  **Пути API:** Исправлены пути в `AuthContext.js` для соответствия новому роутеру.
        4.  **Рендеринг:** Все вхождения `&&` для условного рендеринга в `.js` файлах были заменены на безопасный тернарный оператор (`условие ? <Компонент /> : null`).
        5.  **Кодировка БД:** Была пересоздана база данных из `init.sql` для решения проблемы с отображением кириллицы (знаки вопроса).

2.  **Проблема: Некорректная работа и UX в кабинете родителя.**
    *   **Симптомы:** Кнопка "Смотреть прогресс" не давала очевидного результата. Навигация была запутанной.
    *   **Причина:** Изначальная реализация просто переводила на другую страницу без четкой обратной связи. Отсутствовала общая навигация по разделу.
    *   **Решение:** Кабинет родителя был полностью переработан. Вместо простого списка внедрена система вкладок: "Мои дети", "Прогресс", "Новости". Логика компонента `Progress.js` была изменена, чтобы он мог работать внутри этой вкладки и принимать отфильтрованный ID ребенка напрямую, а не через состояние роутера. Это сделало UX понятным и логичным.

3.  **Проблема: Ошибки в кабинете тренера при просмотре прогресса.**
    *   **Симптомы:** `SyntaxError: Unexpected token '<'` (падение PHP) и `Warning: Encountered two children with the same key` (ошибка дублирования ключей в React).
    *   **Причина:** SQL-запрос в `progress.php` для роли тренера был написан некорректно. Он вызывал ошибку, если у тренера не было филиалов, и дублировал записи, если тренер и ребенок состояли в нескольких общих филиалах.
    *   **Решение:** SQL-запрос был переписан: теперь он сначала получает список филиалов тренера, а затем использует `SELECT DISTINCT` и `IN (...)` для безопасного и корректного получения уникальных записей о прогрессе.